<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <div class="app-container">
        <div class="dashboard-header">
            <h3>Admin Console</h3>
            <div>
                <span id="user-display" style="margin-right: 15px; opacity: 0.8;">Admin</span>
                <button onclick="logout()" class="secondary" style="width: auto; padding: 8px 15px;">Logout</button>
            </div>
        </div>

        <div class="dashboard-grid">
            <div class="sidebar">
                <button onclick="showSection('requests')" class="secondary">Pending Requests <span id="req-count"
                        style="background:var(--error-color); padding:2px 6px; border-radius:10px; font-size:0.7em;">0</span></button>
                <button onclick="showSection('rooms')" class="secondary">Manage Rooms</button>
                <button onclick="showSection('users')" class="secondary">All Users</button>
            </div>

            <div class="main-content">
                <!-- Requests Section -->
                <div id="section-requests" class="section">
                    <h2>Pending Join Requests</h2>
                    <div id="requests-list"></div>
                </div>

                <!-- Rooms Section -->
                <div id="section-rooms" class="section" style="display:none;">
                    <h2>Manage Rooms</h2>
                    <div style="display:flex; gap:10px; margin-bottom:20px;">
                        <input id="new-room-name" placeholder="New Room Name">
                        <button onclick="createRoom()" style="width:auto;">Create</button>
                    </div>
                    <div id="rooms-list"></div>
                </div>

                <!-- Users Section -->
                <div id="section-users" class="section" style="display:none;">
                    <h2>Registered Users</h2>
                    <div id="users-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.onload = async () => {
            let res = await fetch('/api/admin/dashboard-data');
            if (!res.ok) window.location.href = 'index.html';
            let data = await res.json();
            renderData(data);
        };

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            window.location.href = 'index.html';
        }

        function showSection(id) {
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById('section-' + id).style.display = 'block';
        }

        let currentData = null;

        function renderData(data) {
            currentData = data;

            // Requests
            const reqList = document.getElementById('requests-list');
            reqList.innerHTML = '';
            document.getElementById('req-count').innerText = data.requests.length;

            if (data.requests.length === 0) reqList.innerHTML = '<p style="opacity:0.5">No pending requests.</p>';

            data.requests.forEach(req => {
                reqList.innerHTML += `
                    <div class="card" style="margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <span><b>${req.username}</b> wants to join <b>${req.roomName}</b></span>
                        <div style="display:flex; gap:10px;">
                            <button onclick="handle('${req.id}', 'APPROVED')" style="width:auto; background:var(--success-color)">Approve</button>
                            <button onclick="handle('${req.id}', 'REJECTED')" style="width:auto; background:var(--error-color)">Reject</button>
                        </div>
                    </div>
                `;
            });

            // Rooms
            const roomList = document.getElementById('rooms-list');
            roomList.innerHTML = '';
            data.rooms.forEach(room => {
                roomList.innerHTML += `
                    <div class="room-item">
                        <span>${room.name}</span>
                        <button onclick="deleteRoom('${room.id}')" class="danger" style="width:auto; padding:5px 10px;">Delete</button>
                    </div>
                `;
            });

            // Users
            const userList = document.getElementById('users-list');
            userList.innerHTML = '';
            data.users.forEach(u => {
                userList.innerHTML += `<div class="room-item"><span>${u.username} (${u.role})</span></div>`;
            });
        }

        async function handle(id, status) {
            await fetch(`/api/admin/handle-request?requestId=${id}&status=${status}`, { method: 'POST' });
            reload();
        }

        async function createRoom() {
            let name = document.getElementById('new-room-name').value;
            if (!name) return;
            await fetch(`/api/admin/create-room?name=${name}`, { method: 'POST' });
            document.getElementById('new-room-name').value = '';
            reload();
        }

        async function deleteRoom(id) {
            if (!confirm('Delete room?')) return;
            await fetch(`/api/admin/delete-room?id=${id}`, { method: 'POST' });
            reload();
        }

        async function reload() {
            let res = await fetch('/api/admin/dashboard-data');
            if (res.ok) renderData(await res.json());
        }
    </script>
</body>

</html>